---
title: "Clusterization. Homework"
author: "aslepchenkov"
date: "April 4, 2017"
output: html_document
---

```{r setup, message=FALSE}
library(DESeq2)
library(ggplot2)
library(pheatmap)
library(amap)
library(dbscan)
options(width=120)
```



```{r load}
counts <- read.csv("GSE89225_Illumina_counts.csv", row.names=1)
conditions <- read.csv("conditions.csv", row.names=1)
mart <- read.table("human_mart.txt", sep="\t", header=1, check.names = F)
```

Возьмем весь датасет с аутлаером
Создадим DeseqDataSet объект (дизайн не важен)
Оставим только 8000 экспрессированых генов
Используем rlog(dds) для получения логарифмированных значений экспрессии
Посчитаем корреляции между образцами используя cor (результатом будет матрица размера m×mm×m, где m – количество образцов)
Посчитаем матрицу “непохожести” 1 - cor, и dist объект для этой матрицы
Сделаем кластеризацию с помощью функции hclust, используя три разных метода “связывания” объектов в группы: average, complete and single
Построим для каждой график с помощью plot
```{r deseq_prep, cache=TRUE, message=FALSE}
dds <- DESeqDataSetFromMatrix(countData = counts,
                              colData = conditions,
                              design = ~ tissue + cells)
dds <- dds[rowSums(counts(dds)) > 20, ]
dds <- DESeq(dds)
vst_dds <- vst(dds)
counts.norm <- assay(vst_dds)
head(dds[1:8000])
small_dds <- dds[1:8000]
rld <- rlog(small_dds, blind = T)
rld_cor <- cor(assay(rld))
rld_cor_reverse <- 1 - rld_cor 
rld_dist <- dist(rld_cor_reverse)

complete_hclust <- hclust(rld_dist, method = "complete")
average_hclust <- hclust(rld_dist, method = "average")
single_hclust <- hclust(rld_dist, method = "single")

plot(complete_hclust, main = "Complete hclust")
plot(average_hclust, main = "Average hclust")
plot(single_hclust, main = "Single hclust")
?plot
```




Используем K-means для описания паттернов экспрессии

Возьмем весь датасет без аутлаера
Создадим DeseqDataSet объект (дизайн не важен)
Оставим только 8000 экспрессированных генов
Используем rlog(dds) для получения логарифмированных значений экспрессии
Используем функцию Kmeans из пакета amap с методом “correlation”, c количеством кластеров равным 6. (Вы можете выбрать своё количество кластеров), и максимальным количеством итераций равным 20000
После этого вы можете достать соотвествие каждого гена кластеру с помощью элемента листа с названием “cluster”
После этого от вас потребуется эту кластеризацию изобразить на хитмапе: гены должны быть отсортированы по кластерам, а столбцы сначала по клеткам, а затем по тканям.
Пример использования функции Kmeans:

clustering <- Kmeans(rld, 6, method="correlation", iter.max=20000)
head(clustering$cluster)

```{r deseq_prep, cache=TRUE, message=FALSE}
clustering <- Kmeans(assay(rld), 6, method="correlation", iter.max=20000)


str(clustering)
rld_matrix <- assay(rld)
str(rld_matrix)
rld_matrix <- cbind(rld_matrix, clustering$cluster)
rld_matrix[4,]
sorted_clustering <- rld_matrix[order(clustering$cluster),]
str(sorted_clustering)

plot(clustering)

to_visualise_pathway <- t(apply(sorted_clustering, 1, function(r) {
  (r - min(r)) / (max(r) - min(r))
}))


pheatmap(to_visualise_pathway, 
         show_rownames = F, cluster_rows = F,
         cluster_cols=F,
         annotation_col = conditions, 
         col=
         main = "GO:0007159: leukocyte cell-cell adhesion")

heatmap()
?Kmeans
?sort.list
```
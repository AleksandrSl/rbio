---
title: "Test1"
author: "aslepchenkov"
date: "April 8, 2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(DESeq2)
library(ggplot2)
library(pheatmap)
library(plotly)
library(amap)
library(dbscan)
options(width = 120)
```

```{r load_data, message=FALSE, warning=FALSE}
counts <- read.table('FirstBlood/Data/GSE89633_counts.tsv', sep = '\t', row.names = 1, header=1)
conditions <- read.table('FirstBlood/Data/GSE89633_conditions.tsv', sep = '\t', row.names = 1, header=1)
```


```{r dds cache=TRUE}
dds <- DESeqDataSetFromMatrix(countData = counts,
                              colData = conditions,
                              design = ~ cells + conditions)
dds <- dds[rowSums(counts(dds)) > 20, ]
dds <- DESeq(dds)
vst_dds <- vst(dds)
counts.norm <- assay(vst_dds)
```


```{r PCA}
pca_data <- prcomp(t(counts.norm))

percents <- pca_data$sdev^2 / sum(pca_data$sdev^2)
to_plot <- t(counts.norm) %*% pca_data$rotation

gdata <- data.frame(
  x=to_plot[, 1],
  y=to_plot[, 2],
  cells=conditions[, 1],
  conditions=conditions[, 2],
  name=rownames(conditions)
)

ggplotly(ggplot(data=gdata, aes(x=x, y=y, color=cells, shape=conditions, text=name)) +
  geom_point(size=3) + theme_bw()  +
  xlab(paste0("PC", 1, ": ", formatC(100 * percents[1], digits=4), "%")) +
  ylab(paste0("PC", 2, ": ", formatC(100 * percents[2], digits=4), "%")))

plotPCA(vst_dds, intgroup=c("tissue", "cells")) + theme_bw()
```

```{r}

dds <- dds[order(rowSums(counts(dds)), decreasing = T), ]  # Order by expression level
dds_highly_expr <- dds[1:8000]  
dds_highly_expr <- DESeq(dds_highly_expr)

vst_dds_highly_expr <- vst(dds_highly_expr)
highly_expr_counts.norm <- assay(vst_dds_highly_expr)

clustering_highly_expr <- Kmeans(highly_expr_counts.norm, 8, method = "correlation", iter.max = 20000)

highly_expr_ordered_by_count <- highly_expr_counts.norm[order(clustering_highly_expr$cluster), 
                        order(conditions$cells, conditions$conditions)]

to_visualise <- t(apply(highly_expr_ordered_by_count, 1, function(r) {
  (r - min(r)) / (max(r) - min(r))
}))

clusters_df <- data.frame("cluster" = as.factor(clustering_highly_expr$cluster))

png("FirstBlood/heatmap_large.png", width=6, height=20, units="in", res=300)
pheatmap(to_visualise, 
         show_rownames = F, cluster_rows = F,
         cluster_cols = F,
         annotation_col = conditions, 
         annotation_row = clusters_df,
         main = "GO:0007159: leukocyte cell-cell adhesion")

dev.off()


```

Судя по heatmap SampleG и SampleO ведут себя немного странно, но на аутлаеров они не очень похожи





